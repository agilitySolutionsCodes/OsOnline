Imports System.Globalization
Imports System.Data.SqlClient
Imports System.IO
Imports System.Xml

Partial Public Class DetalheOrdemServico
    Inherits System.Web.UI.Page


    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        Try
            If Not IsPostBack Then
                DirectCast(Me.Master.Controls(0).Controls(3).Controls(7).FindControl("menuOsOnline"), Menu).Visible = False
                NomeBotoes()
                PreencherOrigensOS()
                If Request("Numero") Is Nothing Then
                    Incluir()
                Else
                    Dim numero As String = Request("Numero").Substring(0, 6)
                    Selecionar(numero)
                End If
            End If

        Catch ex As Exception
            Dim oRet As New ctlRetornoGenerico
            ctlUtil.EscreverLogErro("DetalheOrdemServico - Page_load: " & ex.Message())
            oRet.Mensagem = ctlUtil.sMsgErroPadrao

            oRet.Sucesso = False
            oMensagem.SetMessage(oRet)
        End Try
    End Sub

    Private Sub Incluir()
        Dim dt As DataTable = ObterEstrutura()
        oMensagem.ClearMessage()
        Preencher(dt)
        pnlCabecalho.Enabled = True
        lblOrdemServico.Text = "000000"
        btnAlterar.Visible = False
        btnNovo.Visible = False
    End Sub

    Private Function ObterEstrutura(Optional ByVal bAdicionarLinha As Boolean = True) As DataTable

        Dim dt As New DataTable

        dt.Columns.Add("Atendente")

        'Ordem de Servi;o
        dt.Columns.Add("CodigoStatusOS")
        dt.Columns.Add("DescricaoStatusOS")
        dt.Columns.Add("NumeroOS")
        dt.Columns.Add("NumeroChamado")
        dt.Columns.Add("ItemChamado")
        dt.Columns.Add("DataEmissao", GetType(DateTime))
        dt.Columns.Add("HoraEmissao")
        dt.Columns.Add("CodigoOrigem")
        dt.Columns.Add("DescricaoOrigem")
        dt.Columns.Add("CodigoTipoChamado")
        dt.Columns.Add("TipoChamado")
        dt.Columns.Add("NomeContato")
        dt.Columns.Add("TelefoneContato")
        dt.Columns.Add("OSParceiro")
        dt.Columns.Add("OSAntiga")

        'Cliente
        dt.Columns.Add("FilialCliente")
        dt.Columns.Add("CodigoCliente")
        dt.Columns.Add("NomeCliente")
        dt.Columns.Add("CGCCliente")
        dt.Columns.Add("LojaCliente")

        'Item da Ordem de Serviço
        dt.Columns.Add("ProximoAtendimento")
        dt.Columns.Add("ItemOS")
        dt.Columns.Add("DescricaoSituacaoOS")
        dt.Columns.Add("CodigoSituacaoOS")
        dt.Columns.Add("CodigoClassificacao")
        dt.Columns.Add("DescricaoClassificacao")
        dt.Columns.Add("CodigoOcorrencia")
        dt.Columns.Add("DescricaoOcorrencia")
        dt.Columns.Add("CodigoEtapa")
        dt.Columns.Add("DescricaoEtapa")
        dt.Columns.Add("DescricaoSituacao")
        dt.Columns.Add("CodigoSituacao")
        dt.Columns.Add("D_E_L_E_T_")
        dt.Columns.Add("DataGarantia")


        'Produto
        dt.Columns.Add("CodigoProduto")
        dt.Columns.Add("DescricaoProduto")
        dt.Columns.Add("NumeroSerieProduto")

        'Sub Item
        dt.Columns.Add("SubItem")
        dt.Columns.Add("DescricaoSubItem")
        dt.Columns.Add("CodigoServico")
        dt.Columns.Add("DescricaoServico")
        dt.Columns.Add("Quantidade")
        dt.Columns.Add("ValorUnitario")
        dt.Columns.Add("Total")

        dt.Columns.Add("Comentario")

        If bAdicionarLinha Then
            AdicionarItem(dt)
        End If
        Return dt

    End Function

    Private Sub Selecionar(ByVal sNumero As String)
        Dim ct As New ctlOrdemServico
        Dim reader As SqlDataReader = Nothing
        If Request("Numero") IsNot Nothing Then
            If Request("Numero").Trim.Contains("H") Then
                reader = ct.Selecionar(sNumero, , False)
            Else
                reader = ct.Selecionar(sNumero)
            End If
        Else
            reader = ct.Selecionar(sNumero)
        End If
        If Not reader.HasRows() Then
            Throw New Exception("A Ordem de Serviço '" + sNumero + "' não foi localizada.")
        Else
            Dim dt As New DataTable
            If reader IsNot Nothing Then
                dt.Load(reader)
                reader.Close()
            End If
            Preencher(dt)
        End If
    End Sub

    Private Sub Preencher(Optional ByVal dt As DataTable = Nothing)

        'preenche dados a partir do xml gravado
        If File.Exists(NomeArquivoXml()) Then
            Dim ds = New DataSet
            ds.ReadXml(NomeArquivoXml())
            If (ds.Tables.Count > 0) Then
                If String.IsNullOrEmpty(dt.Rows(0).Item("NumeroOs").ToString) Then dt.Rows(0).Item("NumeroOs") = "000000"
                If ds.Tables(0).Rows(0).Item("Licenciado").ToString.Trim = HttpContext.Current.User.Identity.Name.Trim _
                    And dt.Rows(0).Item("NumeroOs").ToString = ds.Tables(0).Rows(0).Item("NumeroOs").ToString Then
                    dt = ds.Tables(0)

                    'se for inclusao desabilita alteracao de cliente - porque produtos tem relacao direta com cliente
                    If String.IsNullOrEmpty(dt.Rows(0).Item("Atendente").ToString) Then
                        txtCliente.Enabled = False
                    End If

                    'printar msg na tela informando que existem dados alterados e não salvos
                    Dim oRet As New ctlRetornoGenerico
                    oRet.Mensagem = "Existem itens alterados e/ou incluídos que não foram salvos no servidor. Por favor clicar no botão confirmar."
                    oRet.Sucesso = True
                    oMensagem.SetMessage(oRet)

                End If
            End If
        End If

        grdItens.DataSource = dt
        grdItens.DataBind()
        lblChamado.Text = dt.Rows(0).Item("NumeroChamado").ToString
        lblOrdemServico.Text = dt.Rows(0).Item("NumeroOs").ToString
        If VarType(dt.Rows(0).Item("DataEmissao")) = CDbl(Str(8)) Then
            lblEmissao.Text = dt.Rows(0).Item("DataEmissao").ToString()
        Else
            lblEmissao.Text = DirectCast(dt.Rows(0).Item("DataEmissao"), Date).ToString("dd/MM/yyyy")
        End If

        txtCliente.Codigo = dt.Rows(0).Item("CodigoCliente").ToString
        txtCliente.Loja = dt.Rows(0).Item("LojaCliente").ToString
        txtCliente.Nome = dt.Rows(0).Item("NomeCliente").ToString
        txtCliente.CPF_CNPJ = dt.Rows(0).Item("CGCCliente").ToString
        txtContato.Text = dt.Rows(0).Item("NomeContato").ToString
        oPhoneBox.Text = dt.Rows(0).Item("TelefoneContato").ToString
        If String.IsNullOrEmpty(lblChamado.Text.Trim) Then
            'lblTitContato.Visible = False
            'txtTitTelefone.Visible = False
            'txtContato.Visible = False
            'oPhoneBox.Visible = False
            grdItens.Columns(5).Visible = False
        End If
        txtOSParceiro.Text = dt.Rows(0).Item("OSParceiro").ToString
        If Not String.IsNullOrEmpty(dt.Rows(0).Item("OSAntiga").ToString.Trim) Then
            txtOSAntiga.Text = dt.Rows(0).Item("OSAntiga").ToString
            lblOSAntiga.Visible = True
            txtOSAntiga.Visible = True
        End If
        If Not String.IsNullOrEmpty(dt.Rows(0).Item("CodigoSituacao").ToString) Then
            ViewState.Add("CodigoSituacao", CInt(dt.Rows(0).Item("CodigoSituacao").ToString))
        End If
        If Not String.IsNullOrEmpty(dt.Rows(0).Item("CodigoOrigem").ToString) Then
            drpOrigem.SelectedValue = dt.Rows(0).Item("CodigoOrigem").ToString
        End If
        If dt.Rows(0).Item("CodigoTipoChamado").ToString = "E" Then
            drpTipo.SelectedIndex = 2
        ElseIf dt.Rows(0).Item("CodigoTipoChamado").ToString = "I" Then
            drpTipo.SelectedIndex = 1
        End If
        btnImprimir.CommandArgument = dt.Rows(0).Item("NumeroOs").ToString.Trim
        'Dim btnAtender As AutoHideButton = DirectCast(dt.Row.FindControl("btnAtender"), AutoHideButton)
        If dt.Rows(0).Item("Atendente").ToString.Trim = HttpContext.Current.User.Identity.Name.Trim Then
            'If CInt(dt.Rows(0).Item("OSALTERADA")) > 0 Then
            'HabilitarModo("V")
            'Else
            HabilitarModo("A")
            'End If
        Else
            HabilitarModo("I")
        End If

        ViewState.Add("OrdemServico", dt)
    End Sub

    Private Sub AdicionarItem(ByRef dt As DataTable, Optional ByVal nIndice As Integer = 0)

        Dim nItem As Integer = 0
        Dim dr As DataRow = dt.NewRow
        dr("Atendente") = ""

        'Ordem de Servico
        dr("CodigoStatusOS") = ""
        dr("DescricaoStatusOS") = ""
        dr("NumeroOS") = ""
        dr("NumeroChamado") = ""
        dr("ItemChamado") = ""
        dr("DataEmissao") = Now.Date
        dr("HoraEmissao") = ""
        dr("CodigoOrigem") = ""
        dr("DescricaoOrigem") = ""
        dr("CodigoTipoChamado") = ""
        dr("TipoChamado") = ""
        dr("NomeContato") = ""
        dr("TelefoneContato") = ""
        dr("OSParceiro") = ""

        'Cliente
        dr("FilialCliente") = ""
        dr("CodigoCliente") = ""
        dr("NomeCliente") = ""
        dr("CGCCliente") = ""
        dr("LojaCliente") = ""

        'Item da Ordem de Serviço
        dr("ItemOS") = ObterIndice()
        dr("DescricaoSituacaoOS") = ""
        dr("CodigoSituacaoOS") = ""
        dr("CodigoClassificacao") = ""
        dr("DescricaoClassificacao") = ""
        dr("CodigoOcorrencia") = ""
        dr("DescricaoOcorrencia") = ""
        dr("CodigoEtapa") = ""
        dr("DescricaoEtapa") = ""
        dr("DescricaoSituacao") = ""
        dr("CodigoSituacao") = ""
        dr("D_E_L_E_T_") = ""
        dr("DataGarantia") = ""

        'Produto
        dr("CodigoProduto") = ""
        dr("DescricaoProduto") = ""
        dr("NumeroSerieProduto") = ""

        '!?
        'dr("NumeroChamado1") = ""
        dr("Comentario") = ""

        If nIndice = 0 Then
            dt.Rows.Add(dr)
        Else
            dt.Rows.InsertAt(dr, nIndice)
        End If

    End Sub

    Private Sub grdItens_RowCommand(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCommandEventArgs) Handles grdItens.RowCommand
        Dim gv As GridView = DirectCast(sender, GridView)
        Dim dt As DataTable = DirectCast(ViewState("OrdemServico"), DataTable)
        If e.CommandName = "Busca" Or e.CommandName = "" Then
            '
        Else
            Dim nIndice As Integer = Integer.Parse(e.CommandArgument.ToString)
            Select Case e.CommandName
                Case "New"
                    nIndice = nIndice + 1
                    AdicionarItem(dt, nIndice)
                    grdItens.EditIndex = nIndice
                    grdItens.SelectedIndex = nIndice
                Case "Edit"
                    grdItens.EditIndex = nIndice
                    grdItens.SelectedIndex = nIndice
                Case "Update"
                    AtualizarItem(grdItens.Rows(nIndice), nIndice)
                    grdItens.EditIndex = -1
                Case "Cancel"
                    'se for alteracao, basta cacelar. se for inclusao, eh necessário remover a linha
                    grdItens.EditIndex = -1
                    'If dt.Rows(0)("Item").ToString = "" Then
                    'dt.Rows.RemoveAt(nIndice)
                    'End If
                Case "Delete"
                    RemoverItem(grdItens.Rows(nIndice), nIndice)
                    Dim cont As Integer = 0
                    If dt.Rows.Count = 0 Then
                        AdicionarItem(dt)
                    Else
                        While cont < dt.Rows.Count
                            Dim D_E_L_E_T_ As String = dt.Rows(cont).Item("D_E_L_E_T_").ToString
                            If D_E_L_E_T_.Equals("*") Then
                                cont += 1
                                If cont = dt.Rows.Count Then
                                    AdicionarItem(dt)
                                End If
                            Else
                                cont = dt.Rows.Count
                            End If
                        End While
                    End If
            End Select
            ViewState.Add("OrdemServico", dt)
            grdItens.DataSource = dt
            grdItens.DataBind()
            'nunca permitir alteração da situação quando for inclusao
            If e.CommandName.Equals("New") And CInt(lblOrdemServico.Text).Equals(0) Then
                DirectCast(grdItens.Rows(nIndice).FindControl("drpSituacao"), DropDownList).Enabled = False
            End If
        End If
    End Sub

    Private Sub grdItens_RowDeleting(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewDeleteEventArgs) Handles grdItens.RowDeleting
    End Sub

    Private Sub grdItens_RowEditing(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewEditEventArgs) Handles grdItens.RowEditing
        If CInt(lblOrdemServico.Text).Equals(0) Then
            DirectCast(grdItens.Rows(e.NewEditIndex).FindControl("drpSituacao"), DropDownList).Enabled = False
        End If
    End Sub

    Private Sub grdItens_RowUpdating(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewUpdateEventArgs) Handles grdItens.RowUpdating
    End Sub

    Private Sub grdItens_RowCancelingEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCancelEditEventArgs) Handles grdItens.RowCancelingEdit
    End Sub

    Private Sub AtualizarItem(ByVal gr As GridViewRow, ByVal nIndice As Integer)
        Dim oBaseInstaladaView = DirectCast(gr.FindControl("oBaseInstaladaView"), BaseInstaladaView)
        Dim txtPecaSerie = DirectCast(gr.FindControl("txtPecaSerie"), TextBox)
        Dim drpClassificacao = DirectCast(gr.FindControl("drpClassificacao"), DropDownList)
        Dim drpSituacao = DirectCast(gr.FindControl("drpSituacao"), DropDownList)
        Dim drpOcorrencia = DirectCast(gr.FindControl("drpOcorrencia"), DropDownList)
        Dim drpEtapa = DirectCast(gr.FindControl("drpEtapa"), DropDownList)
        Dim dt As DataTable
        dt = DirectCast(ViewState("OrdemServico"), DataTable)
        Dim dr As DataRow = dt.NewRow()
        dr.ItemArray = dt.Rows(nIndice).ItemArray
        dr("CodigoProduto") = oBaseInstaladaView.Codigo.Trim
        dr("DescricaoProduto") = oBaseInstaladaView.Nome.Trim
        dr("NumeroSerieProduto") = oBaseInstaladaView.Serie.Trim
        dr("CodigoClassificacao") = drpClassificacao.SelectedValue
        dr("DescricaoClassificacao") = drpClassificacao.SelectedItem.Text.Trim
        dr("CodigoSituacaoOS") = drpSituacao.SelectedValue
        dr("CodigoOcorrencia") = drpOcorrencia.SelectedValue
        dr("DescricaoOcorrencia") = drpOcorrencia.SelectedItem.Text
        dr("CodigoEtapa") = drpEtapa.SelectedValue
        dr("DescricaoEtapa") = drpEtapa.SelectedItem.Text
        dt.Rows.RemoveAt(nIndice)
        dt.Rows.InsertAt(dr, nIndice)
        dt.AcceptChanges()
    End Sub

    Private Sub RemoverItem(ByVal gr As GridViewRow, ByVal nIndice As Integer)
        Dim lblRegistro = DirectCast(gr.FindControl("lblRegistro"), Label)
        Dim dt As DataTable
        dt = DirectCast(ViewState("OrdemServico"), DataTable)
        Dim dr As DataRow = dt.NewRow()
        dr.ItemArray = dt.Rows(nIndice).ItemArray
        dt.Rows.RemoveAt(nIndice)
        If Not String.IsNullOrEmpty(lblRegistro.Text) Then
            dr("D_E_L_E_T_") = "*"
            dt.Rows.InsertAt(dr, nIndice)
            dt.AcceptChanges()
        End If
    End Sub

    Private Sub btnIncluir_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnIncluir.Click
        Dim oRet As New ctlRetornoGenerico
        Try
            Dim ct As New ctlOrdemServico
            Dim sUsuario As String = HttpContext.Current.User.Identity.Name
            oRet = Validar()
            If oRet.Sucesso Then
                Dim dt As DataTable = DirectCast(ViewState("OrdemServico"), DataTable)
                Dim oOrdemServico As New ctlOrdemServico()
                Dim oCliente As New ctlCliente(txtCliente.Codigo, txtCliente.Loja, txtCliente.Nome, txtCliente.CPF_CNPJ)
                'chamada da criacao do xml contendo todos os dados da pagina
                CriarXmlComItensOS(dt)
                oOrdemServico.OrdemServico = lblOrdemServico.Text
                oOrdemServico.Cliente = oCliente
                oOrdemServico.OSParceiro = txtOSParceiro.Text
                oOrdemServico.Contato = txtContato.Text.Trim
                oOrdemServico.Telefone = oPhoneBox.Text.Trim
                oOrdemServico.CodigoTipo = drpTipo.SelectedIndex.ToString()
                oOrdemServico.CodigoOrigem = drpOrigem.SelectedValue
                oOrdemServico.PutItens(dt)
                oRet = ct.Incluir(oOrdemServico)
                If oRet.Sucesso Then
                    'caso inclusao for efetuada com sucesso deleta arquivo xml
                    DeletaArquivoXml()

                    Selecionar(oRet.Chave.Substring(2))
                End If
            End If
        Catch ex As Exception
            oRet.Sucesso = False
            ctlUtil.EscreverLogErro("DetalheOrdemServico - btnIncluir_click: " & ex.Message())
            oRet.Mensagem = ctlUtil.sMsgErroPadrao

        End Try
        oMensagem.SetMessage(oRet)
    End Sub

    Private Sub btnNovo_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnNovo.Click
        Response.Redirect("DetalheOrdemServico.aspx")
    End Sub

    Private Sub btnAlterar_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnAlterar.Click
        Dim oRet As New ctlRetornoGenerico
        Try
            Dim ct As New ctlOrdemServico
            Dim sUsuario As String = HttpContext.Current.User.Identity.Name
            oRet = Validar()
            If oRet.Sucesso Then
                Dim dt As DataTable = DirectCast(ViewState("OrdemServico"), DataTable)
                Dim oOrdemServico As New ctlOrdemServico()
                Dim oCliente As New ctlCliente(txtCliente.Codigo, txtCliente.Loja, txtCliente.Nome, txtCliente.CPF_CNPJ)
                'chamada da criacao do xml contendo todos os dados da pagina
                CriarXmlComItensOS(dt)

                oOrdemServico.Chamado = lblChamado.Text
                oOrdemServico.OrdemServico = lblOrdemServico.Text
                oOrdemServico.Cliente = oCliente
                oOrdemServico.Contato = txtContato.Text.Trim
                oOrdemServico.Telefone = oPhoneBox.Text.Trim
                oOrdemServico.OSParceiro = txtOSParceiro.Text
                oOrdemServico.CodigoTipo = drpTipo.SelectedIndex.ToString()
                oOrdemServico.CodigoOrigem = drpOrigem.SelectedValue
                oOrdemServico.PutItens(dt)
                oRet = ct.Alterar(oOrdemServico)
                If oRet.Sucesso Then
                    'caso inclusao for efetuada com sucesso deleta arquivo xml
                    DeletaArquivoXml()

                    Selecionar(oRet.Chave.Substring(2))
                End If
            End If
        Catch ex As Exception
            oRet.Sucesso = False
            ctlUtil.EscreverLogErro("DetalheOrdemServico - btnAlterar_click: " & ex.Message())
            oRet.Mensagem = ctlUtil.sMsgErroPadrao

        End Try
        oMensagem.SetMessage(oRet)
    End Sub

    Private Function Validar() As ctlRetornoGenerico
        Dim oRet As New ctlRetornoGenerico
        oRet.Sucesso = False
        If drpOrigem.SelectedIndex < 1 Then
            oRet.Mensagem = "A origem não foi preenchida."
        ElseIf drpTipo.SelectedIndex < 1 Then
            oRet.Mensagem = "O tipo não foi preenchido."
        ElseIf Not txtCliente.IsValid Then
            oRet.Mensagem = "Selecione um cliente."
        ElseIf txtContato.Text.Trim = "" Then 'And Not String.IsNullOrEmpty(lblChamado.Text.Trim) Then
            oRet.Mensagem = "Forneça o nome do contato."
        ElseIf oPhoneBox.Text.Trim = "" Then 'And Not String.IsNullOrEmpty(lblChamado.Text.Trim) Then
            oRet.Mensagem = "Forneça um telefone de contato."
        ElseIf Not ValidarItens(oRet) Then
            'Itens inválido
        Else
            oRet.Sucesso = True
        End If
        Return oRet
    End Function

    Private Function ValidarItens(ByVal oRet As ctlRetornoGenerico) As Boolean
        Dim bRet As Boolean = False
        Dim lblItemOS As Label
        Dim drpSituacao As DropDownList
        Dim oBaseInstaladaBox As BaseInstaladaBox
        Dim drpClassificacao As DropDownList
        Dim drpOcorrencia As DropDownList
        Dim drpEtapa As DropDownList
        Dim lblD_E_L_E_T_ As Label
        oRet.Mensagem = ""
        If grdItens.EditIndex > -1 Then
            oRet.Mensagem = "A linha " + (grdItens.EditIndex + 1).ToString + " encontra-se em edição e precisa ser confirmada ou cancelada."
        Else
            For Each gr As GridViewRow In grdItens.Rows
                lblItemOS = DirectCast(gr.FindControl("lblItemOS"), Label)
                drpSituacao = DirectCast(gr.FindControl("drpSituacao"), DropDownList)
                oBaseInstaladaBox = DirectCast(gr.FindControl("oBaseInstaladaBox"), BaseInstaladaBox)
                drpClassificacao = DirectCast(gr.FindControl("drpClassificacao"), DropDownList)
                drpOcorrencia = DirectCast(gr.FindControl("drpOcorrencia"), DropDownList)
                drpEtapa = DirectCast(gr.FindControl("drpEtapa"), DropDownList)
                lblD_E_L_E_T_ = DirectCast(gr.FindControl("lblD_E_L_E_T_"), Label)

                If lblD_E_L_E_T_.Text.Trim <> "*" Then
                    If String.IsNullOrEmpty(oBaseInstaladaBox.Serie) Then
                        oRet.Mensagem = "O número de série não foi informado na linha " + (gr.RowIndex + 1).ToString + "."
                    ElseIf String.IsNullOrEmpty(oBaseInstaladaBox.Codigo) Then
                        oRet.Mensagem = "A linha " + (gr.RowIndex + 1).ToString + " não contém um Produto válido. Favor informar um Produto."
                    ElseIf drpClassificacao.SelectedIndex < 1 And Not String.IsNullOrEmpty(lblChamado.Text.Trim) Then
                        oRet.Mensagem = "A classificação não foi preenchida na linha " + (gr.RowIndex + 1).ToString + "."
                    ElseIf drpOcorrencia.SelectedIndex < 1 Then
                        oRet.Mensagem = "A ocorrência não foi preenchida na linha " + (gr.RowIndex + 1).ToString + "."
                    ElseIf drpEtapa.SelectedIndex < 1 Then
                        oRet.Mensagem = "A etapa não foi preenchida na linha " + (gr.RowIndex + 1).ToString + "."
                    End If
                    Dim duplicidade As String = ProcurarMesmaOcorrencia(lblItemOS.Text.Trim, oBaseInstaladaBox.Serie, drpOcorrencia.SelectedValue.Trim, lblD_E_L_E_T_.Text.Trim)
                    If duplicidade <> "" Then
                        oRet.Mensagem = "O equipamento e a ocorrência do item " + lblItemOS.Text + " é a mesma do item " + duplicidade + ", favor alterar a ocorrência."
                        Exit For
                    End If
                End If

            Next
        End If
        If oRet.Mensagem.Trim.Length = 0 Then
            bRet = True
        End If
        Return bRet
    End Function

    ''' <summary>
    ''' Verifica se o número de série e a ocorrência são iguais em itens diferentes.
    ''' </summary>
    ''' <param name="nrItem"></param>
    ''' <param name="nrSerie"></param>
    ''' <param name="ocorrencia"></param>
    ''' <param name="D_E_L_E_T_"></param>
    ''' <returns>Retorna o número do registro duplicado, se não existir duplicidade retorna em branco</returns>
    ''' <remarks></remarks>
    Private Function ProcurarMesmaOcorrencia(ByVal nrItem As String, ByVal nrSerie As String, ByVal ocorrencia As String, ByVal D_E_L_E_T_ As String) As String
        Dim dt As DataTable = DirectCast(ViewState("OrdemServico"), DataTable)
        dt.DefaultView.RowFilter = "D_E_L_E_T_ <> '*'"
        Dim str As String = ""
        For indice = 0 To dt.Rows.Count - 1
            Dim dr As DataRow = dt.Rows(indice)
            If nrSerie = dr("NumeroSerieProduto").ToString.Trim AndAlso ocorrencia = dr("CodigoOcorrencia").ToString.Trim _
                AndAlso D_E_L_E_T_ <> "*" AndAlso nrItem <> dr("ItemOS").ToString.Trim Then
                str = dr("ItemOS").ToString.Trim
                Exit For
            End If
        Next
        Return str
    End Function


    Private Sub grdItens_RowDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles grdItens.RowDataBound

        Dim nColunaTotal As Integer = e.Row.Cells.Count - 1

        If e.Row.RowType = DataControlRowType.DataRow Then

            Dim lblItemOS = DirectCast(e.Row.FindControl("lblItemOS"), Label)
            Dim oBaseInstaladaBox As BaseInstaladaBox = DirectCast(e.Row.FindControl("oBaseInstaladaBox"), BaseInstaladaBox)
            Dim drpClassificacao As DropDownList = DirectCast(e.Row.FindControl("drpClassificacao"), DropDownList)
            Dim drpSituacao As DropDownList = DirectCast(e.Row.FindControl("drpSituacao"), DropDownList)
            Dim drpOcorrencia As DropDownList = DirectCast(e.Row.FindControl("drpOcorrencia"), DropDownList)
            Dim txtServico As TextBox = DirectCast(e.Row.FindControl("txtServico"), TextBox)
            Dim drpEtapa As DropDownList = DirectCast(e.Row.FindControl("drpEtapa"), DropDownList)
            Dim btnAtender As AutoHideButton = DirectCast(e.Row.FindControl("btnAtender"), AutoHideButton)
            Dim btnPrint As AutoHideButton = DirectCast(e.Row.FindControl("btnPrint"), AutoHideButton)
            Dim lblD_E_L_E_T_ As Label = DirectCast(e.Row.FindControl("lblD_E_L_E_T_"), Label)
            Dim dt As DataTable = DirectCast(ViewState("OrdemServico"), DataTable)

            Dim reader As SqlDataReader = Nothing
            Dim ct As New ctlChamadoTecnico
            Dim os As New ctlOrdemServico
            Dim sSelecionado As String

            'Preenche o drop dentro do grid
            If drpSituacao IsNot Nothing Then
                drpSituacao.Items.Insert(0, "O.S")
                drpSituacao.Items(0).Value = "1"
                drpSituacao.Items.Insert(1, "Em atendimento")
                drpSituacao.Items(1).Value = "3"
                drpSituacao.Items.Insert(2, "Atendido")
                drpSituacao.Items(2).Value = "4"
                sSelecionado = DataBinder.Eval(e.Row.DataItem, "CodigoSituacaoOS").ToString.Trim
                If Not String.IsNullOrEmpty(sSelecionado) Then
                    drpSituacao.Items.FindByValue(sSelecionado).Selected = True
                    If CInt(sSelecionado) = 4 Then
                        'drpEtapa.Enabled = False
                        btnAtender.Visible = False
                        btnPrint.Visible = False
                        drpSituacao.Enabled = False
                    End If
                End If
            End If


            reader = ct.ListarClassificacoes
            If drpClassificacao IsNot Nothing Then
                If reader.HasRows Then
                    drpClassificacao.DataSource = reader
                    drpClassificacao.DataBind()
                    drpClassificacao.Items.Insert(0, "Nenhum")
                    drpClassificacao.Items(0).Value = ""
                    sSelecionado = DataBinder.Eval(e.Row.DataItem, "CodigoClassificacao").ToString.Trim
                    If Not String.IsNullOrEmpty(sSelecionado) Then
                        drpClassificacao.Items.FindByValue(sSelecionado).Selected = True
                    End If
                End If
                reader.Close()


                reader = Nothing
            End If

            reader = ct.ListarOcorrencias
            If reader.HasRows Then
                drpOcorrencia.DataSource = reader
                drpOcorrencia.DataBind()
                drpOcorrencia.Items.Insert(0, "Nenhum")
                drpOcorrencia.Items(0).Value = ""
                sSelecionado = DataBinder.Eval(e.Row.DataItem, "CodigoOcorrencia").ToString.Trim
                If Not String.IsNullOrEmpty(sSelecionado) Then
                    drpOcorrencia.Items.FindByValue(sSelecionado).Selected = True
                End If
                reader.Close()
            End If

            reader = Nothing
            reader = os.ListarEtapasOS()
            If reader.HasRows Then
                drpEtapa.DataSource = reader
                drpEtapa.DataBind()
                drpEtapa.Items.Insert(0, "Nenhum")
                drpEtapa.Items(0).Value = ""
                sSelecionado = DataBinder.Eval(e.Row.DataItem, "CodigoEtapa").ToString.Trim
                If Not String.IsNullOrEmpty(sSelecionado) Then
                    drpEtapa.Items.FindByValue(sSelecionado).Selected = True
                Else
                    'drpEtapa.Items(1).Selected = True
                End If
            End If

            'If drpOcorrencia IsNot Nothing Then
            '    Dim ocorrencia As String = drpOcorrencia.SelectedValue.Trim
            '    If ocorrencia.Length < 6 Then
            '        For cont = ocorrencia.Length To 5
            '            ocorrencia = "0" + ocorrencia
            '        Next
            '    End If
            '    If ocorrencia.Length = 6 Then
            '        btnAtender.CommandArgument += "?Ocorrencia=" + ocorrencia
            '    Else
            '        btnAtender.CommandArgument += "?Ocorrencia=000000"
            '    End If
            'Else
            '    btnAtender.CommandArgument += "?Ocorrencia=000000"
            'End If
            'If oBaseInstaladaBox IsNot Nothing Then
            '    btnAtender.CommandArgument += "?Serie=" + oBaseInstaladaBox.Serie.ToString.Trim
            'End If

            If lblD_E_L_E_T_.Text.Equals("*") Then
                e.Row.Visible = False
            Else
                Dim linhaAtual As Integer = e.Row.RowIndex
                Dim ultimaLinhaVisivel As Integer = ObterUltimaLinhaNaoDeletada(linhaAtual)
                If ultimaLinhaVisivel <> -1 Then
                    Dim cell As GridViewRow = grdItens.Rows(ultimaLinhaVisivel)
                    If cell.BackColor = Nothing Then
                        e.Row.BackColor = System.Drawing.Color.FromArgb(204, 255, 221)
                    Else
                        e.Row.BackColor = Nothing
                    End If
                Else
                    e.Row.BackColor = System.Drawing.Color.FromArgb(204, 255, 221)
                End If
            End If

            reader.Close()

        End If

    End Sub

    Private Function ObterUltimaLinhaNaoDeletada(ByVal linhaAtual As Integer) As Integer
        If linhaAtual > 0 Then
            Dim cell As GridViewRow = grdItens.Rows(linhaAtual - 1)
            Dim lblD_E_L_E_T_ As Label = DirectCast(cell.Cells(6).FindControl("lblD_E_L_E_T_"), Label)
            If lblD_E_L_E_T_.Text.Equals("*") Then
                Return ObterUltimaLinhaNaoDeletada(linhaAtual - 1)
            Else
                Return linhaAtual - 1
            End If
        Else
            Return -1
        End If
    End Function

    Private Sub TituloPagina(ByVal sTexto As String)
        DirectCast(Me.Master.Controls(0).Controls(3).Controls(7).FindControl("oBarraUsuario"), BarraUsuario).PaginaAtual = sTexto
    End Sub

    Private Sub NomeBotoes()
        btnIncluir.NomePainelMensagem = oMensagem.ClientID
        btnIncluir.NomePainelBotoes = pnlBotoes.ClientID
        btnAlterar.NomePainelMensagem = oMensagem.ClientID
        btnAlterar.NomePainelBotoes = pnlBotoes.ClientID
    End Sub

    Private Sub PreencherOrigensOS()
        Dim reader As SqlDataReader
        Dim os As New ctlOrdemServico
        reader = os.ListarOrigensOS
        drpOrigem.DataSource = reader
        drpOrigem.DataBind()
        drpOrigem.Items.Insert(0, "Nenhum")
        reader.Close()
    End Sub

    Protected Sub btnAtender_Click(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim btnAtender As AutoHideButton = DirectCast(sender, AutoHideButton)
        For count As Integer = 0 To grdItens.Rows.Count - 1
            Dim wucAutoHideButton = DirectCast(grdItens.Rows(count).FindControl("btnAtender"), AutoHideButton)
            If wucAutoHideButton.CommandArgument = btnAtender.CommandArgument Then
                Dim oBaseInstaladaBox = DirectCast(grdItens.Rows(count).FindControl("oBaseInstaladaBox"), BaseInstaladaBox)
                Dim drpOcorrencia = DirectCast(grdItens.Rows(count).FindControl("drpOcorrencia"), DropDownList)
                Dim dtGarantia = DirectCast(grdItens.Rows(count).FindControl("lblDtGarantia"), Label)
                Dim vAtendimento() As String = Nothing
                ReDim Preserve vAtendimento(2)
                vAtendimento(0) = oBaseInstaladaBox.Serie.Trim
                vAtendimento(1) = drpOcorrencia.SelectedValue.Trim
                vAtendimento(2) = CDate(dtGarantia.Text).ToShortDateString
                Session("Atendimento") = vAtendimento
                Response.Redirect("DetalheAtendimento.aspx?Numero=" + btnAtender.CommandArgument)
            End If
        Next
    End Sub

    Protected Sub btnPrint_Click(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim btnPrint = DirectCast(sender, AutoHideButton)
        Dim numero As String = btnPrint.CommandArgument
        Dim aOpcao() As String
        ReDim Preserve aOpcao(5)
        aOpcao(0) = ""
        aOpcao(1) = "Defina o modelo de impressão."
        aOpcao(2) = "Aprovador/Técnico"
        aOpcao(3) = "ImpressaoAtendimento.aspx?Numero=" + numero + "?Modo=C"
        aOpcao(4) = "Cliente/Aprovador/Técnico"
        aOpcao(5) = "ImpressaoAtendimento.aspx?Numero=" + numero + "?Modo=D"
        oPopupBox.Exibir(aOpcao)
    End Sub

    Private Sub btnImprimir_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnImprimir.Click
        Response.Redirect("ImpressaoOrdemServico.aspx?Numero=" + btnImprimir.CommandArgument)
    End Sub

    Private Sub HabilitarCamposOS()
        lblTitOrigem.Visible = True
        drpOrigem.Visible = True
        grdItens.Columns(5).Visible = True
        grdItens.Columns(6).Visible = True
        btnImprimir.Visible = True
    End Sub

    Private Sub DesabilitarCamposOS()
        lblTitOrigem.Visible = False
        drpOrigem.Visible = False
        grdItens.Columns(5).Visible = False
        grdItens.Columns(6).Visible = False
        btnImprimir.Visible = False
    End Sub


    Private Sub btnVoltar_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnVoltar.Click
        Response.Redirect("ConsultaOrdemServico.aspx")
    End Sub

    Private Sub HabilitarModo(ByVal codigo As String)
        If codigo = "I" Then
            TituloPagina("Ordem de Serviço - Incluir")
            btnNovo.Visible = False
            btnIncluir.Visible = True
            btnAlterar.Visible = False
            btnImprimir.Visible = False
            'txtCliente.Enabled = True
            grdItens.Columns(1).Visible = False
        ElseIf codigo = "A" Then
            TituloPagina("Ordem de Serviço - Alterar")
            btnNovo.Visible = True
            btnIncluir.Visible = False
            btnAlterar.Visible = True
            btnImprimir.Visible = True
            txtCliente.Enabled = False
            grdItens.Columns(1).Visible = True
            'ElseIf codigo = "V" Then
            'TituloPagina("Ordem de Serviço - Visualizar")
            'btnIncluir.Visible = False
            'btnAlterar.Visible = False
            'txtCliente.Enabled = False
            'btnImprimir.Visible = False
            'grdItens.Enabled = False
        End If
    End Sub

    Private Function ObterIndice() As String
        Dim indice As Integer = 0
        Dim dt As DataTable
        dt = DirectCast(ViewState("OrdemServico"), DataTable)
        If dt IsNot Nothing Then
            For Each dr As DataRow In dt.Rows
                If CInt(dr("ItemOS")) > indice Then
                    indice = CInt(dr("ItemOS"))
                End If
            Next
            indice += 1
            If indice >= 10 Then
                Return indice.ToString
            Else
                Return "0" + indice.ToString
            End If
        End If
        Return "01"
    End Function

    Private Function PossuiChamadoEmBrancoComStatusAberto() As Boolean

        Dim dt As DataTable = DirectCast(ViewState("OrdemServico"), DataTable)
        Dim bRet As Boolean = False
        If String.IsNullOrEmpty(dt.Rows(0)("NumeroChamado").ToString.Trim) And dt.Rows(0)("CodigoStatusOS").Equals("A") Then
            bRet = True
        End If

        Return bRet
    End Function

    Private Sub CriarXmlComItensOS(ByVal dt As DataTable)

        Dim writer As New XmlTextWriter(NomeArquivoXml(), Nothing)
        Dim sTipo As String = ""

        'inicia o documento xml
        writer.WriteStartDocument()

        'define a indentação do arquivo
        writer.Formatting = Formatting.Indented

        'escreve um comentario
        writer.WriteComment("Cabeçalho e itens de Ordem de Servico")

        'escreve o elmento raiz
        writer.WriteStartElement("OrdemServico")

        If drpTipo.SelectedIndex.ToString = "2" Then
            sTipo = "E"
        ElseIf drpTipo.SelectedIndex.ToString = "1" Then
            sTipo = "I"
        End If

        For Each dr As DataRow In dt.Rows
            writer.WriteStartElement("itens")

            If CInt(lblOrdemServico.Text) = 0 Then
                writer.WriteElementString("Atendente", "")
            Else
                writer.WriteElementString("Atendente", HttpContext.Current.User.Identity.Name)
            End If
            writer.WriteElementString("Licenciado", HttpContext.Current.User.Identity.Name)

            'Ordem de Servico
            writer.WriteElementString("CodigoStatusOS", "")
            writer.WriteElementString("DescricaoStatusOS", "")
            writer.WriteElementString("NumeroOS", lblOrdemServico.Text)
            writer.WriteElementString("NumeroChamado", lblChamado.Text)
            writer.WriteElementString("ItemChamado", "")
            writer.WriteElementString("DataEmissao", lblEmissao.Text)
            writer.WriteElementString("HoraEmissao", "")
            writer.WriteElementString("CodigoOrigem", drpOrigem.SelectedValue)
            writer.WriteElementString("DescricaoOrigem", "")
            writer.WriteElementString("CodigoTipoChamado", sTipo)
            writer.WriteElementString("TipoChamado", "")
            writer.WriteElementString("NomeContato", txtContato.Text)
            writer.WriteElementString("TelefoneContato", oPhoneBox.Text)
            writer.WriteElementString("OSParceiro", txtOSParceiro.Text)
            writer.WriteElementString("OSAntiga", txtOSAntiga.Text)

            'Cliente
            writer.WriteElementString("FilialCliente", "") 'ver o que preencher
            writer.WriteElementString("CodigoCliente", txtCliente.Codigo)
            writer.WriteElementString("NomeCliente", txtCliente.Nome)
            writer.WriteElementString("CGCCliente", txtCliente.CPF_CNPJ)
            writer.WriteElementString("LojaCliente", txtCliente.Loja)

            'Item da Ordem de Serviço
            writer.WriteElementString("ProximoAtendimento", dr.Item("ProximoAtendimento").ToString)
            writer.WriteElementString("ItemOS", dr.Item("ItemOS").ToString)
            writer.WriteElementString("DescricaoSituacaoOS", dr.Item("DescricaoSituacaoOS").ToString)
            writer.WriteElementString("CodigoSituacaoOS", dr.Item("CodigoSituacaoOS").ToString)
            writer.WriteElementString("CodigoClassificacao", dr.Item("CodigoClassificacao").ToString)
            writer.WriteElementString("DescricaoClassificacao", dr.Item("DescricaoClassificacao").ToString)
            writer.WriteElementString("CodigoOcorrencia", dr.Item("CodigoOcorrencia").ToString)
            writer.WriteElementString("DescricaoOcorrencia", dr.Item("DescricaoOcorrencia").ToString)
            writer.WriteElementString("CodigoEtapa", dr.Item("CodigoEtapa").ToString)
            writer.WriteElementString("DescricaoEtapa", dr.Item("DescricaoEtapa").ToString)
            writer.WriteElementString("DescricaoSituacao", dr.Item("DescricaoSituacao").ToString)
            writer.WriteElementString("CodigoSituacao", dr.Item("CodigoSituacao").ToString)
            writer.WriteElementString("D_E_L_E_T_", dr.Item("D_E_L_E_T_").ToString)
            writer.WriteElementString("DataGarantia", dr.Item("DataGarantia").ToString)


            'Produto
            writer.WriteElementString("CodigoProduto", dr.Item("CodigoProduto").ToString)
            writer.WriteElementString("DescricaoProduto", dr.Item("DescricaoProduto").ToString)
            writer.WriteElementString("NumeroSerieProduto", dr.Item("NumeroSerieProduto").ToString)

            'Sub Item
            writer.WriteElementString("SubItem", "")
            writer.WriteElementString("DescricaoSubItem", "")
            writer.WriteElementString("CodigoServico", "")
            writer.WriteElementString("DescricaoServico", "")
            writer.WriteElementString("Quantidade", "")
            writer.WriteElementString("ValorUnitario", "")
            writer.WriteElementString("Total", "")

            writer.WriteElementString("Comentario", "")

            writer.WriteEndElement()
        Next

        ' encerra o elemento raiz
        writer.WriteFullEndElement()

        'Escreve o XML para o arquivo e fecha o objeto escritor
        writer.Close()
    End Sub

    Private Sub DeletaArquivoXml()
        If File.Exists(NomeArquivoXml()) Then
            File.Delete(NomeArquivoXml())
        End If
    End Sub


    ' Retorna o nome e caminho do arquivo xml
    Private Function NomeArquivoXml() As String

        Dim sNomeArquivo As String = Server.MapPath("~") & "\arquivos_xml_erros_os_online"

        If Not Directory.Exists(sNomeArquivo) Then
            Directory.CreateDirectory(sNomeArquivo)
        End If

        Return sNomeArquivo & "\ordem_servico_" & HttpContext.Current.User.Identity.Name.Trim & ".xml"

    End Function

End Class